@using DataSource;
@using DataView;
@using FinancesBlazor.Components.Grid.Cells;
@inject DataViewManager _dataViewManager;
@implements IDisposable;

<tr class="@(_checked ? "checked" : null)">
    <td><RadzenCheckBox TValue="bool" class="checkbox" Value=@_checked Change=@(args => CheckChange(args)) /></td>
    @foreach (var column in DataView?.Columns!)
    {
        <DynamicCell DataView=@DataView Row=@Row Column=column></DynamicCell>
    }
</tr>

@code {
    [Parameter]
    public DataView? DataView { get; set; }

    [Parameter]
    public DataRow? Row { get; set; }

    private bool _checked;

    protected override void OnInitialized()
    {
        _dataViewManager.DetailsChanged += DetailsChanged;

        if (DataView == null)
            return;
        _checked = _dataViewManager.RecordIsChecked(DataView, Row);
    }

    private void CheckChange(bool args)
    {
        if (DataView == null)
            return;
        if (args)
            _dataViewManager.CheckRecord(DataView, Row);
        else
            _dataViewManager.UncheckRecord(DataView, Row);
        _checked = args;
        _dataViewManager.Save(DataView);
    }

    async void DetailsChanged(object? sender, Dictionary<string, DataView> checkedRecords)
    {
        if (DataView == null)
            return;
        _checked = _dataViewManager.RecordIsChecked(DataView, Row);
        StateHasChanged();
    }

    void IDisposable.Dispose()
    {
        _dataViewManager.DetailsChanged -= DetailsChanged;
    }
}
