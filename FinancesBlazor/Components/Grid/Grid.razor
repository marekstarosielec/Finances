@using DataView;
@using FinancesBlazor.Components.Grid.Filters;
@using System.Text.Json.Nodes;
@using FinancesBlazor.Components.Grid.Rows
@using Radzen.Blazor.Rendering;
@inject DataViewManager _dataViewManager;
@implements IDisposable;

<div class="toolbar">
    <button class="btn btn-primary" @onclick="() => ReloadDataRequest()"><span class="fa fa-refresh"></span></button>
    <button class="btn btn-primary" @onclick="() => RemoveFilters()"><span class="fa-layers fa-fw"><i class="fa fa-filter"></i><i class="fa-solid fa-xmark fa-lg red"></i></span></button>
    @if (DataView?.Query?.Prefilters != null)
    {
        <button class="btn btn-primary" @ref=_prefilterInvoker @onclick="@(args => _prefilterPopup.ToggleAsync(_prefilterInvoker))"><span class="fa fa-bolt"></span></button>
        <Popup @ref=_prefilterPopup Lazy=false class="popup red" Style="display:none;position:absolute;padding:5px;border:1px">
            <div class="prefilterContent">
                @foreach (var prefilter in DataView.Query.Prefilters)
                {
                    <div class="form-check form-switch">
                        <input class="form-check-input background-red" type="checkbox" value="" id=@prefilter.Name checked=@prefilter.Applied @onclick="() => ChangePrefilter(prefilter)">
                        <label class="form-check-label default-text" for=@prefilter.Name>
                            @prefilter.Title
                        </label>
                    </div>
                }
            </div>
        </Popup>
    }
</div>

@if (DataView?.Columns != null)
{
    <table class="table table-borderless">
        <thead>
            <tr>
                @foreach (var column in DataView.Columns)
                {
                    <th>
                        <div class="@(column.HorizontalAlign == DataViewColumnContentAlign.Right ? "text-end dropdown" : "dropdown")">
                            <button class="btn columnHeader" type="button" @ref=_popupInvokers[column] @onclick="@(args => _popups[column].ToggleAsync(_popupInvokers[column]))">@column.Title <span hidden="@ColumnHeaderArrowHidden(column, true)"><span class="fa fa-arrow-down blue"></span></span><span hidden="@ColumnHeaderArrowHidden(column, false)"><span class="fa fa-arrow-up yellow"></span></span></button>
                            <Popup @ref=_popups[column] Lazy=false class="popup" Style="display:none;position:absolute;padding:5px;border:1px">
                                <DynamicFilter DataView=@DataView Column=column @ref=_dynamicFilters[column] Popup="@_popups[column]" ElementReference="@_popupInvokers[column]" />
                            </Popup>
                        </div>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @if (DataView?.Result?.Rows != null)
            {
                @foreach (var row in DataView.Result.Rows)
                {
                    <DynamicRow DataView=@DataView Row=@row></DynamicRow>
                }
            }
        </tbody>
    </table>
}
@code {
    private Dictionary<DataViewColumn, ElementReference> _popupInvokers = new();
    private Dictionary<DataViewColumn, Popup> _popups = new();
    private Dictionary<DataViewColumn, DynamicFilter> _dynamicFilters = new();
    private Popup _prefilterPopup;
    private ElementReference _prefilterInvoker;

    [Parameter]
    public DataView? DataView { get; set; }

    private List<JsonNode?>? _data;

    protected override void OnInitialized()
    {
        _dataViewManager.ViewChanged += ViewChanged;
    }

    private async Task CloseFilters()
    {
        foreach (var kvp in _popups)
            await kvp.Value.CloseAsync();
    }

    private async Task ChangePrefilter(Prefilter prefilter)
    {
        prefilter.Applied = !prefilter.Applied;
        await _dataViewManager.Save(DataView);
    }

    private bool ColumnHeaderArrowHidden(DataViewColumn column, bool descending) => DataView?.Query.Sorters.ContainsKey(column) == false || DataView?.Query.Sorters[column] != descending;

    private async void ReloadDataRequest()
    {
        // if (View == null)
        //     return;
        // await CloseFilters();
        // await View.Service.Reload();
        // _data = View.Service.Data;
        // StateHasChanged();
    }

    private async void RemoveFilters()
    {
        if (DataView == null || DataView?.Query.Filters == null)
            return;

        DataView.Query.Filters.Clear();
        await _dataViewManager.Save(DataView);
    }

    void ViewChanged(object? sender, DataView e)
    {
        if (DataView != e)
            return;
        StateHasChanged();
    }

    void IDisposable.Dispose()
    {
        _dataViewManager.ViewChanged -= ViewChanged;
    }
}
